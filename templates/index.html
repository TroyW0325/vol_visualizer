<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Troy's Implied Volatility Surface Visualizer</title>
  
  <!-- Include Plotly for interactive charts -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  
  <!-- Polyfill for ES6 support -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  
  <!-- MathJax for LaTeX rendering -->
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  
  <style>
    /* Basic page styling */
    body { 
      background-color: #121212; /* Dark background */
      color: #e0e0e0;            /* Light text */
      font-family: Arial, sans-serif; 
      margin: 20px; 
      line-height: 1.6;
    }
    h1, h2, h3, h4 { color: #e0e0e0; }
    
    /* Form styling */
    form { margin-bottom: 20px; }
    input, button {
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      margin-right: 10px;
    }
    input { width: 200px; }
    button {
      background-color: #0077cc;
      color: white;
      cursor: pointer;
    }
    button:hover { background-color: #005fa3; }
    
    /* Graph containers: max-width to avoid horizontal scrolling */
    .graph-container { 
      margin-bottom: 40px; 
      max-width: 1000px; 
      margin-left: auto; 
      margin-right: auto;
    }
    .graph-title {
      margin-bottom: 10px;
      font-size: 20px;
      text-align: center;
    }
    
    /* Explanation section styling */
    .explanation {
      margin-top: 20px;
      padding: 20px;
      background-color: #1e1e1e;
      border-radius: 8px;
    }
    .section { margin-bottom: 30px; }
  </style>
</head>
<body>
  <!-- Page Header -->
  <h1>Troy's Implied Volatility Surface Visualizer</h1>
  
  <!-- Ticker Input Form -->
  <form id="ticker-form">
    <label for="ticker">Enter Ticker Symbol:</label>
    <input type="text" id="ticker" name="ticker" placeholder="e.g., AAPL" required>
    <button type="submit">Submit</button>
  </form>

  <!-- 3D IV Surface Graphs -->
  <div class="graph-container">
    <div class="graph-title">3D Implied Volatility Surface - Calls</div>
    <div id="chart-calls" style="width:100%; height:700px;"></div>
  </div>
  <div class="graph-container">
    <div class="graph-title">3D Implied Volatility Surface - Puts</div>
    <div id="chart-puts" style="width:100%; height:700px;"></div>
  </div>

  <!-- 2D Volatility Smile Graphs -->
  <div class="graph-container">
    <div class="graph-title">2D Volatility Smile - Calls</div>
    <div id="smile-chart-calls" style="width:100%; height:600px;"></div>
  </div>
  <div class="graph-container">
    <div class="graph-title">2D Volatility Smile - Puts</div>
    <div id="smile-chart-puts" style="width:100%; height:600px;"></div>
  </div>

  <!-- Professional Options Education Section -->
  <div class="explanation">
    <!-- Black–Scholes Model Explanation -->
    <div class="section">
      <h2>Options, Implied Volatility, and the Black–Scholes Model</h2>
      <p>
        The <strong>Black–Scholes model</strong> is used to price European options. For a call option:
      </p>
      <p>
        \[
        C = S \cdot N(d_1) - K \cdot e^{-rT} \cdot N(d_2)
        \]
        with
        \[
        d_1 = \frac{\ln(S/K) + (r + \frac{\sigma^2}{2})T}{\sigma\sqrt{T}}, \quad d_2 = d_1 - \sigma\sqrt{T}
        \]
      </p>
      <p>
        Here, \(S\) is the current stock price, \(K\) is the strike price, \(T\) is time to expiration (in years), \(r\) is the risk‑free rate, and \(\sigma\) is the volatility. The implied volatility (IV) is the value of \(\sigma\) that, when substituted into the model, gives the observed market price.
      </p>
    </div>

    <!-- Option Greeks Explanation -->
    <div class="section">
      <h2>Option Greeks</h2>
      <p>
        The <strong>Greeks</strong> quantify the sensitivities of an option's price:
      </p>
      <ul>
        <li>
          <strong>Delta (\(\Delta\)):</strong> The rate of change of the option price with respect to changes in the underlying asset's price.  
          (Call: \(\Delta_{call} = N(d_1)\); Put: \(\Delta_{put} = N(d_1)-1\))
        </li>
        <li>
          <strong>Gamma (\(\Gamma\)):</strong> The rate of change of Delta with respect to changes in the underlying price.  
          \(\Gamma = \frac{N'(d_1)}{S\sigma\sqrt{T}}\)
        </li>
        <li>
          <strong>Theta (\(\Theta\)):</strong> The sensitivity of the option price to time decay.
        </li>
        <li>
          <strong>Vega (\(V\)):</strong> The sensitivity to volatility changes.  
          \(Vega = S\sqrt{T} \cdot N'(d_1)\)
        </li>
        <li>
          <strong>Rho (\(\rho\)):</strong> The sensitivity to changes in the risk‑free rate.
        </li>
      </ul>
    </div>

    <!-- Volatility Smile Explanation -->
    <div class="section">
      <h2>Volatility Smile and Its Implications</h2>
      <p>
        The <strong>volatility smile</strong> is a pattern in which options with strike prices far from the current price tend to have higher IV. This suggests that the market anticipates larger moves in the underlying asset.
      </p>
      <p>
        High IV may indicate market uncertainty (and expensive options), while low IV might suggest lower expected movement or undervalued premiums.
      </p>
    </div>

    <!-- Common Options Trading Strategies & Payoff Diagrams -->
    <div class="section">
      <h2>Common Options Trading Strategies &amp; Payoff Diagrams</h2>
      <p>
        Below are some common strategies along with their payoff diagrams. For each strategy, the individual legs’ payoffs are shown as light gray dotted lines, and the net payoff (after subtracting a hypothetical premium) is displayed in a distinct color. All diagrams use the same x‑axis ([50,150]) and y‑axis (–15 to 55) scales.
      </p>
      <ul>
        <li><strong>Long Straddle:</strong> Buy a call and a put at the same strike (assumed total premium = 10).</li>
        <li><strong>Long Strangle:</strong> Buy an out‑of‑the‑money call and put (assumed total premium = 10).</li>
        <li><strong>Bull Call Spread:</strong> Buy a call at a lower strike and sell a call at a higher strike (assumed net premium = 3).</li>
        <li><strong>Bear Put Spread:</strong> Buy a put at a higher strike and sell a put at a lower strike (assumed net premium = 3).</li>
        <li><strong>Butterfly Spread:</strong> Combine calls (buy 1 at 90, sell 2 at 100, buy 1 at 110) (assumed net premium = 1).</li>
      </ul>
      <!-- Containers for payoff diagrams -->
      <div id="payoff-straddle" style="width: 100%; height: 500px;"></div>
      <div id="payoff-strangle" style="width: 100%; height: 500px;"></div>
      <div id="payoff-bullcall" style="width: 100%; height: 500px;"></div>
      <div id="payoff-bearput" style="width: 100%; height: 500px;"></div>
      <div id="payoff-butterfly" style="width: 100%; height: 500px;"></div>
    </div>
  </div>

  <script>
    // JavaScript code to fetch IV surface data and render 3D and 2D graphs

    document.getElementById('ticker-form').addEventListener('submit', function(e) {
      e.preventDefault();
      var ticker = document.getElementById('ticker').value;
      var formData = new URLSearchParams();
      formData.append('ticker', ticker);

      // Fetch IV surface data from the server endpoint /vol_surface
      fetch('/vol_surface', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: formData.toString()
      })
      .then(response => response.json())
      .then(data => {
        if(data.error) { alert(data.error); return; }
        
        // Compute common axis ranges for 3D graphs
        var minStrike = Math.min.apply(null, data.grid_x);
        var maxStrike = Math.max.apply(null, data.grid_x);
        var minDays = Math.min.apply(null, data.grid_y);
        var maxDays = Math.max.apply(null, data.grid_y);

        // --- Render 3D Surface Plot for Calls ---
        if(data.calls_Z) {
          var traceCalls = {
            x: data.grid_x,
            y: data.grid_y,
            z: data.calls_Z,
            type: 'surface',
            colorscale: 'Blues',
            opacity: 0.9,
            showscale: true,
            colorbar: { title: 'Call IV (%)' }
          };
          var layoutCalls = {
            title: "Calls: IV Surface for " + ticker.toUpperCase(),
            paper_bgcolor: '#121212',
            plot_bgcolor: '#121212',
            font: { color: 'white' },
            scene: {
              xaxis: { title: 'Strike Price', color: 'white', gridcolor: '#333', range: [minStrike, maxStrike] },
              yaxis: { title: 'Days to Expiration', color: 'white', gridcolor: '#333', range: [minDays, maxDays] },
              zaxis: { title: 'IV (%)', color: 'white', gridcolor: '#333' },
              bgcolor: '#121212'
            }
          };
          Plotly.newPlot('chart-calls', [traceCalls], layoutCalls);
        } else {
          document.getElementById('chart-calls').innerHTML = "<p>No calls data available.</p>";
        }

        // --- Render 3D Surface Plot for Puts ---
        if(data.puts_Z) {
          var tracePuts = {
            x: data.grid_x,
            y: data.grid_y,
            z: data.puts_Z,
            type: 'surface',
            colorscale: 'Reds',
            opacity: 0.9,
            showscale: true,
            colorbar: { title: 'Put IV (%)' }
          };
          var layoutPuts = {
            title: "Puts: IV Surface for " + ticker.toUpperCase(),
            paper_bgcolor: '#121212',
            plot_bgcolor: '#121212',
            font: { color: 'white' },
            scene: {
              xaxis: { title: 'Strike Price', color: 'white', gridcolor: '#333', range: [minStrike, maxStrike] },
              yaxis: { title: 'Days to Expiration', color: 'white', gridcolor: '#333', range: [minDays, maxDays] },
              zaxis: { title: 'IV (%)', color: 'white', gridcolor: '#333' },
              bgcolor: '#121212'
            }
          };
          Plotly.newPlot('chart-puts', [tracePuts], layoutPuts);
        } else {
          document.getElementById('chart-puts').innerHTML = "<p>No puts data available.</p>";
        }

        // --- Render 2D Volatility Smile for Calls ---
        if(data.calls_time && data.calls_time.length > 0) {
          var callsSorted = data.calls_time.slice().sort((a, b) => a - b);
          var medianCalls = callsSorted[Math.floor(callsSorted.length / 2)];
          var tolerance = 5;
          var smileCalls_strike = [], smileCalls_iv = [];
          for(var i = 0; i < data.calls_time.length; i++){
            if(Math.abs(data.calls_time[i] - medianCalls) < tolerance){
              smileCalls_strike.push(data.calls_strike[i]);
              smileCalls_iv.push(data.calls_iv[i]);
            }
          }
          var traceSmileCalls = {
            x: smileCalls_strike,
            y: smileCalls_iv,
            mode: 'markers+lines',
            marker: { size: 6, color: '#00ccff' },
            line: { color: '#00ccff' },
            type: 'scatter',
            name: 'Calls'
          };
          var layoutSmileCalls = {
            title: "Calls: Volatility Smile near " + medianCalls + " Days",
            paper_bgcolor: '#121212',
            plot_bgcolor: '#121212',
            font: { color: 'white' },
            xaxis: { title: 'Strike Price', color: 'white', gridcolor: '#333', range: [50,150] },
            yaxis: { title: 'IV (%)', color: 'white', gridcolor: '#333', range: [-15,55] }
          };
          Plotly.newPlot('smile-chart-calls', [traceSmileCalls], layoutSmileCalls);
        } else {
          document.getElementById('smile-chart-calls').innerHTML = "<p>No calls data available.</p>";
        }

        // --- Render 2D Volatility Smile for Puts ---
        if(data.puts_time && data.puts_time.length > 0) {
          var putsSorted = data.puts_time.slice().sort((a, b) => a - b);
          var medianPuts = putsSorted[Math.floor(putsSorted.length / 2)];
          var tolerance = 5;
          var smilePuts_strike = [], smilePuts_iv = [];
          for(var i = 0; i < data.puts_time.length; i++){
            if(Math.abs(data.puts_time[i] - medianPuts) < tolerance){
              smilePuts_strike.push(data.puts_strike[i]);
              smilePuts_iv.push(data.puts_iv[i]);
            }
          }
          var traceSmilePuts = {
            x: smilePuts_strike,
            y: smilePuts_iv,
            mode: 'markers+lines',
            marker: { size: 6, color: '#ff6600' },
            line: { color: '#ff6600' },
            type: 'scatter',
            name: 'Puts'
          };
          var layoutSmilePuts = {
            title: "Puts: Volatility Smile near " + medianPuts + " Days",
            paper_bgcolor: '#121212',
            plot_bgcolor: '#121212',
            font: { color: 'white' },
            xaxis: { title: 'Strike Price', color: 'white', gridcolor: '#333', range: [50,150] },
            yaxis: { title: 'IV (%)', color: 'white', gridcolor: '#333', range: [-15,55] }
          };
          Plotly.newPlot('smile-chart-puts', [traceSmilePuts], layoutSmilePuts);
        } else {
          document.getElementById('smile-chart-puts').innerHTML = "<p>No puts data available.</p>";
        }
      })
      .catch(error => { console.error('Error:', error); });
    });

    // Generate Payoff Diagrams for Options Trading Strategies with Leg Payoffs
    function generatePayoffDiagrams() {
      // Define a common underlying price range and common axis scales
      var x = [];
      for (var p = 50; p <= 150; p += 1) { x.push(p); }
      var xRange = [50, 150];
      var yRange = [-15, 55]; // Common y-axis for all payoff diagrams

      /* === Long Straddle === */
      // Parameters
      var K_straddle = 100;
      var premium_straddle = 10;
      // Leg payoffs:
      var call_payoff_straddle = x.map(function(price) { return Math.max(price - K_straddle, 0); });
      var put_payoff_straddle = x.map(function(price) { return Math.max(K_straddle - price, 0); });
      // Net payoff = call + put - premium
      var net_payoff_straddle = x.map(function(price, i) { 
        return call_payoff_straddle[i] + put_payoff_straddle[i] - premium_straddle; 
      });
      // Traces for each leg (light gray dashed lines)
      var traceCallLeg = {
        x: x,
        y: call_payoff_straddle,
        mode: 'lines',
        line: { color: '#cccccc', dash: 'dot' },
        name: 'Call Leg'
      };
      var tracePutLeg = {
        x: x,
        y: put_payoff_straddle,
        mode: 'lines',
        line: { color: '#cccccc', dash: 'dot' },
        name: 'Put Leg'
      };
      // Net payoff trace (distinct color)
      var traceNetStraddle = {
        x: x,
        y: net_payoff_straddle,
        mode: 'lines',
        line: { color: '#00ccff' },
        name: 'Net Payoff'
      };
      var layoutStraddle = {
        title: "Long Straddle Payoff (Strike = " + K_straddle + ", Premium = " + premium_straddle + ")",
        xaxis: { title: 'Underlying Price', range: xRange },
        yaxis: { title: 'Net Payoff', range: yRange },
        paper_bgcolor: '#121212',
        plot_bgcolor: '#121212',
        font: { color: 'white' }
      };
      Plotly.newPlot('payoff-straddle', [traceCallLeg, tracePutLeg, traceNetStraddle], layoutStraddle);

      /* === Long Strangle === */
      var K1_strangle = 90, K2_strangle = 110;
      var premium_strangle = 10;
      var call_payoff_strangle = x.map(function(price) { return Math.max(price - K2_strangle, 0); });
      var put_payoff_strangle = x.map(function(price) { return Math.max(K1_strangle - price, 0); });
      var net_payoff_strangle = x.map(function(price, i) { return call_payoff_strangle[i] + put_payoff_strangle[i] - premium_strangle; });
      var traceCallStrangle = {
        x: x,
        y: call_payoff_strangle,
        mode: 'lines',
        line: { color: '#cccccc', dash: 'dot' },
        name: 'Call Leg'
      };
      var tracePutStrangle = {
        x: x,
        y: put_payoff_strangle,
        mode: 'lines',
        line: { color: '#cccccc', dash: 'dot' },
        name: 'Put Leg'
      };
      var traceNetStrangle = {
        x: x,
        y: net_payoff_strangle,
        mode: 'lines',
        line: { color: '#ffcc00' },
        name: 'Net Payoff'
      };
      var layoutStrangle = {
        title: "Long Strangle Payoff (K1 = " + K1_strangle + ", K2 = " + K2_strangle + ", Premium = " + premium_strangle + ")",
        xaxis: { title: 'Underlying Price', range: xRange },
        yaxis: { title: 'Net Payoff', range: yRange },
        paper_bgcolor: '#121212',
        plot_bgcolor: '#121212',
        font: { color: 'white' }
      };
      Plotly.newPlot('payoff-strangle', [traceCallStrangle, tracePutStrangle, traceNetStrangle], layoutStrangle);

      /* === Bull Call Spread === */
      var K1_bull = 95, K2_bull = 105;
      var netPremium_bull = 3;
      var call_buy_payoff = x.map(function(price) { return Math.max(price - K1_bull, 0); });
      var call_sell_payoff = x.map(function(price) { return -Math.max(price - K2_bull, 0); });
      var net_payoff_bull = x.map(function(price, i) { return call_buy_payoff[i] + call_sell_payoff[i] - netPremium_bull; });
      var traceBuyCall = {
        x: x,
        y: call_buy_payoff,
        mode: 'lines',
        line: { color: '#cccccc', dash: 'dot' },
        name: 'Buy Call (95)'
      };
      var traceSellCall = {
        x: x,
        y: call_sell_payoff,
        mode: 'lines',
        line: { color: '#cccccc', dash: 'dot' },
        name: 'Sell Call (105)'
      };
      var traceNetBull = {
        x: x,
        y: net_payoff_bull,
        mode: 'lines',
        line: { color: '#00ff00' },
        name: 'Net Payoff'
      };
      var layoutBull = {
        title: "Bull Call Spread Payoff (Buy at " + K1_bull + ", Sell at " + K2_bull + ", Premium = " + netPremium_bull + ")",
        xaxis: { title: 'Underlying Price', range: xRange },
        yaxis: { title: 'Net Payoff', range: yRange },
        paper_bgcolor: '#121212',
        plot_bgcolor: '#121212',
        font: { color: 'white' }
      };
      Plotly.newPlot('payoff-bullcall', [traceBuyCall, traceSellCall, traceNetBull], layoutBull);

      /* === Bear Put Spread === */
      var K1_bear = 105, K2_bear = 95;
      var netPremium_bear = 3;
      var put_buy_payoff = x.map(function(price) { return Math.max(K1_bear - price, 0); });
      var put_sell_payoff = x.map(function(price) { return -Math.max(K2_bear - price, 0); });
      var net_payoff_bear = x.map(function(price, i) { return put_buy_payoff[i] + put_sell_payoff[i] - netPremium_bear; });
      var traceBuyPut = {
        x: x,
        y: put_buy_payoff,
        mode: 'lines',
        line: { color: '#cccccc', dash: 'dot' },
        name: 'Buy Put (105)'
      };
      var traceSellPut = {
        x: x,
        y: put_sell_payoff,
        mode: 'lines',
        line: { color: '#cccccc', dash: 'dot' },
        name: 'Sell Put (95)'
      };
      var traceNetBear = {
        x: x,
        y: net_payoff_bear,
        mode: 'lines',
        line: { color: '#ff0000' },
        name: 'Net Payoff'
      };
      var layoutBear = {
        title: "Bear Put Spread Payoff (Buy at " + K1_bear + ", Sell at " + K2_bear + ", Premium = " + netPremium_bear + ")",
        xaxis: { title: 'Underlying Price', range: xRange },
        yaxis: { title: 'Net Payoff', range: yRange },
        paper_bgcolor: '#121212',
        plot_bgcolor: '#121212',
        font: { color: 'white' }
      };
      Plotly.newPlot('payoff-bearput', [traceBuyPut, traceSellPut, traceNetBear], layoutBear);

      /* === Butterfly Spread === */
      var K1_butter = 90, K2_butter = 100, K3_butter = 110;
      var netPremium_butter = 1;
      var leg1 = x.map(function(price) { return Math.max(price - K1_butter, 0); });
      var leg2 = x.map(function(price) { return -2 * Math.max(price - K2_butter, 0); });
      var leg3 = x.map(function(price) { return Math.max(price - K3_butter, 0); });
      var net_payoff_butter = x.map(function(price, i) { return leg1[i] + leg2[i] + leg3[i] - netPremium_butter; });
      var traceLeg1 = {
        x: x,
        y: leg1,
        mode: 'lines',
        line: { color: '#cccccc', dash: 'dot' },
        name: 'Buy Call (90)'
      };
      var traceLeg2 = {
        x: x,
        y: leg2,
        mode: 'lines',
        line: { color: '#cccccc', dash: 'dot' },
        name: 'Sell 2 Calls (100)'
      };
      var traceLeg3 = {
        x: x,
        y: leg3,
        mode: 'lines',
        line: { color: '#cccccc', dash: 'dot' },
        name: 'Buy Call (110)'
      };
      var traceNetButter = {
        x: x,
        y: net_payoff_butter,
        mode: 'lines',
        line: { color: '#ff66cc' },
        name: 'Net Payoff'
      };
      var layoutButter = {
        title: "Butterfly Spread Payoff (K1 = " + K1_butter + ", K2 = " + K2_butter + ", K3 = " + K3_butter + ", Premium = " + netPremium_butter + ")",
        xaxis: { title: 'Underlying Price', range: xRange },
        yaxis: { title: 'Net Payoff', range: yRange },
        paper_bgcolor: '#121212',
        plot_bgcolor: '#121212',
        font: { color: 'white' }
      };
      Plotly.newPlot('payoff-butterfly', [traceLeg1, traceLeg2, traceLeg3, traceNetButter], layoutButter);
    }

    // Generate payoff diagrams when the page loads
    document.addEventListener('DOMContentLoaded', generatePayoffDiagrams);
  </script>
</body>
</html>
