<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Troy's Implied Volatility Surface Visualizer</title>
  <!-- Include Plotly JS library -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <!-- Load MathJax for rendering LaTeX formulas -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
  </script>
  <style>
    body { 
      background-color: #121212; 
      color: #e0e0e0; 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      line-height: 1.6;
    }
    h1, h2, h3, h4 { color: #e0e0e0; }
    form { margin-bottom: 20px; }
    input, button {
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      margin-right: 10px;
    }
    input { width: 200px; }
    button {
      background-color: #0077cc;
      color: white;
      cursor: pointer;
    }
    button:hover { background-color: #005fa3; }
    .graph-container { margin-bottom: 40px; }
    .graph-title { margin-bottom: 10px; font-size: 20px; text-align: center; }
    .explanation { margin-top: 20px; padding: 20px; background-color: #1e1e1e; border-radius: 8px; }
    .section { margin-bottom: 30px; }
  </style>
</head>
<body>
  <h1>Troy's Implied Volatility Surface Visualizer</h1>
  <form id="ticker-form">
    <label for="ticker">Enter Ticker Symbol:</label>
    <input type="text" id="ticker" name="ticker" placeholder="e.g., AAPL" required>
    <button type="submit">Submit</button>
  </form>

  <!-- 3D Surface Graphs -->
  <div class="graph-container">
    <div class="graph-title">3D Implied Volatility Surface - Calls</div>
    <div id="chart-calls" style="width:100%; height:600px;"></div>
  </div>
  <div class="graph-container">
    <div class="graph-title">3D Implied Volatility Surface - Puts</div>
    <div id="chart-puts" style="width:100%; height:600px;"></div>
  </div>

  <!-- 2D Volatility Smile Graphs -->
  <div class="graph-container">
    <div class="graph-title">2D Volatility Smile - Calls</div>
    <div id="smile-chart-calls" style="width:100%; height:600px;"></div>
  </div>
  <div class="graph-container">
    <div class="graph-title">2D Volatility Smile - Puts</div>
    <div id="smile-chart-puts" style="width:100%; height:600px;"></div>
  </div>

  <!-- Professional Options Education Section -->
  <div class="explanation">
    <div class="section">
      <h2>Options, Implied Volatility, and the Black–Scholes Model</h2>
      <p>
        The <strong>Black–Scholes model</strong> is used to price European options. For a call option, the formula is:
      </p>
      <p>
        \[
        C = S \cdot N(d_1) - K \cdot e^{-rT} \cdot N(d_2)
        \]
        with
        \[
        d_1 = \frac{\ln(S/K) + \left(r + \frac{\sigma^2}{2}\right) T}{\sigma \sqrt{T}}, \quad d_2 = d_1 - \sigma \sqrt{T}
        \]
      </p>
      <p>
        Here, \(S\) is the current stock price, \(K\) is the strike price, \(T\) is time to expiration (in years), \(r\) is the risk‑free rate, and \(\sigma\) is the volatility. The <strong>implied volatility (IV)</strong> is the \(\sigma\) that makes the model price match the observed market price.
      </p>
    </div>

    <div class="section">
      <h2>Option Greeks</h2>
      <p>
        The <strong>Greeks</strong> measure the sensitivities of an option's price:
      </p>
      <ul>
        <li><strong>Delta (\(\Delta\)):</strong> The rate of change of the option price with respect to changes in the underlying asset's price. For a call: \(\Delta_{call} = N(d_1)\); for a put: \(\Delta_{put} = N(d_1)-1\).</li>
        <li><strong>Gamma (\(\Gamma\)):</strong> The rate of change of Delta with respect to changes in the underlying price. \(\Gamma = \frac{N'(d_1)}{S\sigma\sqrt{T}}\).</li>
        <li><strong>Theta (\(\Theta\)):</strong> The sensitivity of the option price to the passage of time (time decay).</li>
        <li><strong>Vega (\(V\)):</strong> The sensitivity of the option price to changes in volatility. \(Vega = S\sqrt{T} \cdot N'(d_1)\).</li>
        <li><strong>Rho (\(\rho\)):</strong> The sensitivity of the option price to changes in the risk‑free rate.</li>
      </ul>
    </div>

    <div class="section">
      <h2>Volatility Smile and Its Implications</h2>
      <p>
        The <strong>volatility smile</strong> is the tendency for options far from the current price (either in‑ or out‑of‑the‑money) to have higher IV. High IV may indicate market uncertainty or expensive options, while low IV might suggest undervalued premiums.
      </p>
    </div>

    <div class="section">
      <h2>Common Options Trading Strategies</h2>
      <p>
        Traders use various strategies to manage risk or capitalize on market views. Some common strategies include:
      </p>
      <ul>
        <li><strong>Long Straddle:</strong> Buy a call and a put at the same strike. Profits from large moves in either direction.</li>
        <li><strong>Long Strangle:</strong> Buy an out‑of‑the‑money call and put with different strikes. Cheaper than a straddle but requires a bigger move.</li>
        <li><strong>Bull Call Spread:</strong> Buy a call at a lower strike and sell a call at a higher strike, capping profit but reducing cost.</li>
        <li><strong>Bear Put Spread:</strong> Buy a put at a higher strike and sell a put at a lower strike, profiting from a moderate decline.</li>
        <li><strong>Butterfly Spread:</strong> Combine calls (or puts) at three strikes to profit if the underlying stays near the middle strike.</li>
      </ul>
    </div>

    <div class="section">
      <h2>Payoff Diagrams for Common Options Trading Strategies</h2>
      <div id="payoff-straddle" style="width: 100%; height: 400px;"></div>
      <div id="payoff-strangle" style="width: 100%; height: 400px;"></div>
      <div id="payoff-bullcall" style="width: 100%; height: 400px;"></div>
      <div id="payoff-bearput" style="width: 100%; height: 400px;"></div>
      <div id="payoff-butterfly" style="width: 100%; height: 400px;"></div>
    </div>
  </div>

  <script>
    // Fetch and render the IV surfaces and volatility smile charts
    document.getElementById('ticker-form').addEventListener('submit', function(e) {
      e.preventDefault();
      var ticker = document.getElementById('ticker').value;
      var formData = new URLSearchParams();
      formData.append('ticker', ticker);

      fetch('/vol_surface', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: formData.toString()
      })
      .then(response => response.json())
      .then(data => {
        if(data.error) { alert(data.error); return; }
        
        // Compute common axis ranges from the grid data
        var minStrike = Math.min.apply(null, data.grid_x);
        var maxStrike = Math.max.apply(null, data.grid_x);
        var minDays = Math.min.apply(null, data.grid_y);
        var maxDays = Math.max.apply(null, data.grid_y);
        var config = { scrollZoom: false }; // Disable scroll zoom for easier page scrolling

        // 3D Surface Plot for Calls
        if(data.calls_Z) {
          var traceCalls = {
            x: data.grid_x,
            y: data.grid_y,
            z: data.calls_Z,
            type: 'surface',
            colorscale: 'Blues',
            opacity: 0.9,
            showscale: true,
            colorbar: { title: 'Call IV (%)' }
          };
          var layoutCalls = {
            title: "Calls: IV Surface for " + ticker.toUpperCase(),
            paper_bgcolor: '#121212',
            plot_bgcolor: '#121212',
            font: { color: 'white' },
            scene: {
              xaxis: { title: 'Strike Price', color: 'white', gridcolor: '#333', range: [minStrike, maxStrike] },
              yaxis: { title: 'Days to Expiration', color: 'white', gridcolor: '#333', range: [minDays, maxDays] },
              zaxis: { title: 'IV (%)', color: 'white', gridcolor: '#333' },
              bgcolor: '#121212'
            }
          };
          Plotly.newPlot('chart-calls', [traceCalls], layoutCalls, config);
        } else {
          document.getElementById('chart-calls').innerHTML = "<p>No calls data available.</p>";
        }

        // 3D Surface Plot for Puts
        if(data.puts_Z) {
          var tracePuts = {
            x: data.grid_x,
            y: data.grid_y,
            z: data.puts_Z,
            type: 'surface',
            colorscale: 'Reds',
            opacity: 0.9,
            showscale: true,
            colorbar: { title: 'Put IV (%)' }
          };
          var layoutPuts = {
            title: "Puts: IV Surface for " + ticker.toUpperCase(),
            paper_bgcolor: '#121212',
            plot_bgcolor: '#121212',
            font: { color: 'white' },
            scene: {
              xaxis: { title: 'Strike Price', color: 'white', gridcolor: '#333', range: [minStrike, maxStrike] },
              yaxis: { title: 'Days to Expiration', color: 'white', gridcolor: '#333', range: [minDays, maxDays] },
              zaxis: { title: 'IV (%)', color: 'white', gridcolor: '#333' },
              bgcolor: '#121212'
            }
          };
          Plotly.newPlot('chart-puts', [tracePuts], layoutPuts, config);
        } else {
          document.getElementById('chart-puts').innerHTML = "<p>No puts data available.</p>";
        }

        // 2D Volatility Smile Plot for Calls
        if(data.calls_time && data.calls_time.length > 0) {
          var callsSorted = data.calls_time.slice().sort((a, b) => a - b);
          var medianCalls = callsSorted[Math.floor(callsSorted.length / 2)];
          var tolerance = 5; // days
          var smileCalls_strike = [], smileCalls_iv = [];
          for(var i = 0; i < data.calls_time.length; i++){
            if(Math.abs(data.calls_time[i] - medianCalls) < tolerance){
              smileCalls_strike.push(data.calls_strike[i]);
              smileCalls_iv.push(data.calls_iv[i]);
            }
          }
          var traceSmileCalls = {
            x: smileCalls_strike,
            y: smileCalls_iv,
            mode: 'markers+lines',
            marker: { size: 6, color: '#00ccff' },
            line: { color: '#00ccff' },
            type: 'scatter',
            name: 'Calls'
          };
          var layoutSmileCalls = {
            title: "Calls: Volatility Smile near " + medianCalls + " Days",
            paper_bgcolor: '#121212',
            plot_bgcolor: '#121212',
            font: { color: 'white' },
            xaxis: { title: 'Strike Price', color: 'white', gridcolor: '#333' },
            yaxis: { title: 'IV (%)', color: 'white', gridcolor: '#333' }
          };
          Plotly.newPlot('smile-chart-calls', [traceSmileCalls], layoutSmileCalls);
        } else {
          document.getElementById('smile-chart-calls').innerHTML = "<p>No calls data available.</p>";
        }

        // 2D Volatility Smile Plot for Puts
        if(data.puts_time && data.puts_time.length > 0) {
          var putsSorted = data.puts_time.slice().sort((a, b) => a - b);
          var medianPuts = putsSorted[Math.floor(putsSorted.length / 2)];
          var tolerance = 5; // days
          var smilePuts_strike = [], smilePuts_iv = [];
          for(var i = 0; i < data.puts_time.length; i++){
            if(Math.abs(data.puts_time[i] - medianPuts) < tolerance){
              smilePuts_strike.push(data.puts_strike[i]);
              smilePuts_iv.push(data.puts_iv[i]);
            }
          }
          var traceSmilePuts = {
            x: smilePuts_strike,
            y: smilePuts_iv,
            mode: 'markers+lines',
            marker: { size: 6, color: '#ff6600' },
            line: { color: '#ff6600' },
            type: 'scatter',
            name: 'Puts'
          };
          var layoutSmilePuts = {
            title: "Puts: Volatility Smile near " + medianPuts + " Days",
            paper_bgcolor: '#121212',
            plot_bgcolor: '#121212',
            font: { color: 'white' },
            xaxis: { title: 'Strike Price', color: 'white', gridcolor: '#333' },
            yaxis: { title: 'IV (%)', color: 'white', gridcolor: '#333' }
          };
          Plotly.newPlot('smile-chart-puts', [traceSmilePuts], layoutSmilePuts);
        } else {
          document.getElementById('smile-chart-puts').innerHTML = "<p>No puts data available.</p>";
        }
      })
      .catch(error => { console.error('Error:', error); });

    // Generate Payoff Diagrams for Common Options Trading Strategies
    function generatePayoffDiagrams() {
      // Define an underlying price range and a set of strikes
      var x = [];
      for (var p = 50; p <= 150; p += 1) { x.push(p); }

      // Long Straddle (Strike = 100)
      var K_straddle = 100;
      var y_straddle = x.map(function(price) { return Math.abs(price - K_straddle); });
      var traceStraddle = {
        x: x,
        y: y_straddle,
        mode: 'lines',
        line: { color: '#00ccff' },
        name: 'Long Straddle'
      };
      var layoutStraddle = {
        title: "Long Straddle Payoff (Strike = " + K_straddle + ")",
        xaxis: { title: 'Underlying Price' },
        yaxis: { title: 'Payoff' },
        paper_bgcolor: '#121212',
        plot_bgcolor: '#121212',
        font: { color: 'white' }
      };
      Plotly.newPlot('payoff-straddle', [traceStraddle], layoutStraddle);

      // Long Strangle (K1 = 90, K2 = 110)
      var K1_strangle = 90, K2_strangle = 110;
      var y_strangle = x.map(function(price) {
        return Math.max(K1_strangle - price, 0) + Math.max(price - K2_strangle, 0);
      });
      var traceStrangle = {
        x: x,
        y: y_strangle,
        mode: 'lines',
        line: { color: '#ffcc00' },
        name: 'Long Strangle'
      };
      var layoutStrangle = {
        title: "Long Strangle Payoff (K1 = " + K1_strangle + ", K2 = " + K2_strangle + ")",
        xaxis: { title: 'Underlying Price' },
        yaxis: { title: 'Payoff' },
        paper_bgcolor: '#121212',
        plot_bgcolor: '#121212',
        font: { color: 'white' }
      };
      Plotly.newPlot('payoff-strangle', [traceStrangle], layoutStrangle);

      // Bull Call Spread (Buy call at 95, Sell call at 105)
      var K1_bull = 95, K2_bull = 105;
      var y_bull = x.map(function(price) {
        return Math.max(price - K1_bull, 0) - Math.max(price - K2_bull, 0);
      });
      var traceBull = {
        x: x,
        y: y_bull,
        mode: 'lines',
        line: { color: '#00ff00' },
        name: 'Bull Call Spread'
      };
      var layoutBull = {
        title: "Bull Call Spread Payoff (Buy at " + K1_bull + ", Sell at " + K2_bull + ")",
        xaxis: { title: 'Underlying Price' },
        yaxis: { title: 'Payoff' },
        paper_bgcolor: '#121212',
        plot_bgcolor: '#121212',
        font: { color: 'white' }
      };
      Plotly.newPlot('payoff-bullcall', [traceBull], layoutBull);

      // Bear Put Spread (Buy put at 105, Sell put at 95)
      var K1_bear = 105, K2_bear = 95;
      var y_bear = x.map(function(price) {
        return Math.max(K1_bear - price, 0) - Math.max(K2_bear - price, 0);
      });
      var traceBear = {
        x: x,
        y: y_bear,
        mode: 'lines',
        line: { color: '#ff0000' },
        name: 'Bear Put Spread'
      };
      var layoutBear = {
        title: "Bear Put Spread Payoff (Buy at " + K1_bear + ", Sell at " + K2_bear + ")",
        xaxis: { title: 'Underlying Price' },
        yaxis: { title: 'Payoff' },
        paper_bgcolor: '#121212',
        plot_bgcolor: '#121212',
        font: { color: 'white' }
      };
      Plotly.newPlot('payoff-bearput', [traceBear], layoutBear);

      // Butterfly Spread using Calls (Buy 1 call at 90, Sell 2 calls at 100, Buy 1 call at 110)
      var K1_butter = 90, K2_butter = 100, K3_butter = 110;
      var y_butter = x.map(function(price) {
        return Math.max(price - K1_butter, 0) - 2 * Math.max(price - K2_butter, 0) + Math.max(price - K3_butter, 0);
      });
      var traceButter = {
        x: x,
        y: y_butter,
        mode: 'lines',
        line: { color: '#ff66cc' },
        name: 'Butterfly Spread'
      };
      var layoutButter = {
        title: "Butterfly Spread Payoff (K1 = " + K1_butter + ", K2 = " + K2_butter + ", K3 = " + K3_butter + ")",
        xaxis: { title: 'Underlying Price' },
        yaxis: { title: 'Payoff' },
        paper_bgcolor: '#121212',
        plot_bgcolor: '#121212',
        font: { color: 'white' }
      };
      Plotly.newPlot('payoff-butterfly', [traceButter], layoutButter);
    }

    // Generate payoff diagrams once the page loads
    document.addEventListener('DOMContentLoaded', generatePayoffDiagrams);
  </script>
</body>
</html>
